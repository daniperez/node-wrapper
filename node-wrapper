#!/bin/sh
##########################################################################
#
# node-wrapper script for Unix 
#
##########################################################################
ARCH="$(uname -i | sed -e 's/i386/86/' -e 's/x86_64/64/')"
OS="$(uname -o | sed -e 's/GNU\/Linux/linux/' -e 's/Darwin/darwin/')"
NODEJS_VERSION="0.8.9"
NPM_VERSION="1.1.9"
NODEJS_PREFIX="$PWD/.node"
NODEJS_URL="http://nodejs.org/dist/v$NODEJS_VERSION/node-v$NODEJS_VERSION-$OS-x$ARCH.tar.gz"
LOG_FILE="node-wrapper.log"
##########################################################################

_NODEJS_ZIP="$NODEJS_PREFIX/node-$NODEJS_VERSION.zip"
_NODEJS_EXE="$NODEJS_PREFIX/node-v$NODEJS_VERSION-$OS-x$ARCH/bin/node"
_NPM_EXE="$NODEJS_PREFIX/node-v$NODEJS_VERSION-$OS-x$ARCH/bin/npm"

##########################################################################
# Error handling 
##########################################################################
check_error () 
{
  if [ ! $? -eq 0 ]
  then
    echo "Error in line $(($1-1))" 1>&2
    exit -1
  fi
}

echo "" > "$LOG_FILE"

mkdir -p "$NODEJS_PREFIX"

##########################################################################
# Install nodejs
##########################################################################
if [ ! -e "$_NODEJS_ZIP" ]; then

  echo "Downloading nodejs into $NODEJS_PREFIX (be patient, it can take several minutes)"
  wget  -O "$_NODEJS_ZIP" "$NODEJS_URL" 1>&2 >> "$LOG_FILE"
  check_error "$LINENO"

fi

##########################################################################
# Untar nodejs
##########################################################################
if [ ! -x "$_NODEJS_EXE" ]; then

  echo "Untarring nodejs at $NODEJS_PREFIX"
  tar xvz -C "$NODEJS_PREFIX" -f "$_NODEJS_ZIP" 1>&2 >> "$LOG_FILE"
  check_error "$LINENO"
fi
